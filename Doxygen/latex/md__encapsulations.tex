\hypertarget{md__encapsulations_autotoc_md1}{}\doxysection{Hardware}\label{md__encapsulations_autotoc_md1}
\hypertarget{md__encapsulations_autotoc_md2}{}\doxysubsection{Mini\+DSP (\+UHS lib, with mods)}\label{md__encapsulations_autotoc_md2}

\begin{DoxyItemize}
\item Read state from Mini\+DSP
\item Set DSP input and volume
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md3}{}\doxysubsection{Power\+Control}\label{md__encapsulations_autotoc_md3}

\begin{DoxyItemize}
\item Control of power to dsp and amps via relays and (if used) EN lines
\item Read back status of each
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md4}{}\doxysection{Knob}\label{md__encapsulations_autotoc_md4}

\begin{DoxyItemize}
\item Quadrature decoder
\item Sample or time-\/based debounce for the button
\item \mbox{\hyperlink{class_button}{Button}} event detector -\/ probably with sample time = loop tick time
\begin{DoxyItemize}
\item Short press\+: release after being down \texorpdfstring{$<$}{<} SHORT counts or \texorpdfstring{$<$}{<} SHORT\+\_\+\+PRESS ms
\item Long press\+: release after count in \mbox{[}SHORT, LONG\mbox{]} or t in \mbox{[}SHORT\+\_\+\+PRESS, LONG\+\_\+\+PRESS\mbox{]} ms
\item Hold\+: down for \texorpdfstring{$>$}{>} HOLD counts or \texorpdfstring{$>$}{>} HOLD\+\_\+\+PRESS ms
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md5}{}\doxysubsection{Button press functions}\label{md__encapsulations_autotoc_md5}
\hypertarget{md__encapsulations_autotoc_md6}{}\doxysubsubsection{While on}\label{md__encapsulations_autotoc_md6}

\begin{DoxyItemize}
\item Short = Mute
\item Long = Change input
\item Hold = Power off 
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md7}{}\doxysubsubsection{While off}\label{md__encapsulations_autotoc_md7}

\begin{DoxyItemize}
\item Short = Power on
\item Hold = Menu
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md8}{}\doxysection{Input and power rules}\label{md__encapsulations_autotoc_md8}
\hypertarget{md__encapsulations_autotoc_md9}{}\doxysubsection{Input detection}\label{md__encapsulations_autotoc_md9}
\hypertarget{md__encapsulations_autotoc_md10}{}\doxysubsubsection{Direct measures}\label{md__encapsulations_autotoc_md10}
These are read directly (no persistent state unless there\textquotesingle{}s filtering on the analog inputs)
\begin{DoxyItemize}
\item Trigger input corresponding to a signal input
\item For analog, detection of signal, which means
\begin{DoxyItemize}
\item Signal present
\item In absence of signal, optional detection of low impedance
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md11}{}\doxysubsubsection{Input sense states\+: Input\+Sense}\label{md__encapsulations_autotoc_md11}
The triggers are just copies of the direct measures. Analog\+Signal has a persistent state to allow a timeout.


\begin{DoxyItemize}
\item DTrigger (direct read)
\begin{DoxyItemize}
\item ABSENT
\item PRESENT
\end{DoxyItemize}
\item ATrigger (direct read)
\begin{DoxyItemize}
\item ABSENT
\item PRESENT
\end{DoxyItemize}
\item Analog\+Signal (state machine)
\begin{DoxyItemize}
\item ABSENT
\begin{DoxyItemize}
\item Signal -\/-\/\texorpdfstring{$>$}{>} PRESENT
\item Low\+Impedance -\/-\/\texorpdfstring{$>$}{>} PRESENT
\end{DoxyItemize}
\item PRESENT
\begin{DoxyItemize}
\item !\+Signal -\/-\/\texorpdfstring{$>$}{>} SILENT
\end{DoxyItemize}
\item SILENT
\begin{DoxyItemize}
\item Holdup\+Time expired -\/-\/\texorpdfstring{$>$}{>} ABSENT
\item !\+Low\+Impedance -\/-\/\texorpdfstring{$>$}{>} ABSENT
\end{DoxyItemize}
\end{DoxyItemize}
\item Analog\+Active = ATrigger == PRESENT $\vert$$\vert$ Analog\+Signal != ABSENT
\item Digital\+Active = DTrigger
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md12}{}\doxysubsubsection{Input state -\/ ANALOG, DIGITAL, NA}\label{md__encapsulations_autotoc_md12}

\begin{DoxyItemize}
\item Current\+Input\+: current from Mini\+DSP -\/ ANALOG, DIGITAL, NA
\item Prior\+Input\+: last from Mini\+DSP
\item Chosen\+Input\+: from inputs/state machine(s) -\/ ANALOG, DIGITAL, NA
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md13}{}\doxysubsubsection{Input/\+Power state machine\+: Power\+State}\label{md__encapsulations_autotoc_md13}
Determination of whether the amp should be on or off based on Input\+Sense, the input selected by the DSP (may be changed by the remote), and the panel buttons
\begin{DoxyItemize}
\item OFF // Respond to any source or panel activity
\begin{DoxyItemize}
\item if Digital\+Button $\vert$$\vert$ Digital\+Active
\begin{DoxyItemize}
\item Chosen\+Input = DIGITAL // Input activity determines the input
\item -\/-\/\texorpdfstring{$>$}{>} ON
\end{DoxyItemize}
\item elseif Analog\+Button $\vert$$\vert$ Analog\+Active
\begin{DoxyItemize}
\item Chosen\+Input = ANALOG
\item -\/-\/\texorpdfstring{$>$}{>} ON
\end{DoxyItemize}
\item elseif Power\+Button
\begin{DoxyItemize}
\item Chosen\+Input = NA
\item -\/-\/\texorpdfstring{$>$}{>} ON
\end{DoxyItemize}
\end{DoxyItemize}
\item ON // Accept any input change from the remote, and monitor the chosen input
\begin{DoxyItemize}
\item if Chosen\+Input == Current\+Input
\begin{DoxyItemize}
\item Chosen\+Input = NA
\end{DoxyItemize}
\item if Current\+Input DIGITAL
\begin{DoxyItemize}
\item if !\+Digital\+Active -\/-\/\texorpdfstring{$>$}{>} WAIT
\end{DoxyItemize}
\item elseif Current\+Input ANALOG
\begin{DoxyItemize}
\item if !\+Analog\+Active -\/-\/\texorpdfstring{$>$}{>} WAIT
\end{DoxyItemize}
\end{DoxyItemize}
\item WAIT // Shutdown in the extended absence of signal or buttons
\begin{DoxyItemize}
\item if Digital\+Button $\vert$$\vert$ Digital\+Active
\begin{DoxyItemize}
\item Chosen\+Input = DIGITAL
\item -\/-\/\texorpdfstring{$>$}{>} ON
\end{DoxyItemize}
\item elseif Analog\+Button $\vert$$\vert$ Analog\+Active
\begin{DoxyItemize}
\item Chosen\+Input = ANALOG
\item -\/-\/\texorpdfstring{$>$}{>} ON
\end{DoxyItemize}
\item elseif Power\+Button $\vert$$\vert$ Wait\+Time expired -\/-\/\texorpdfstring{$>$}{>} OFF
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md14}{}\doxysubsection{Top-\/level state machine}\label{md__encapsulations_autotoc_md14}
\hypertarget{md__encapsulations_autotoc_md15}{}\doxysubsubsection{On Sequence}\label{md__encapsulations_autotoc_md15}

\begin{DoxyEnumerate}
\item DSP power
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Suppress output meter
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Wait for DSP connected to USB stack
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item (optional) volume limit
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Set input if scheduled
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Amp power
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Enable output meter
\end{DoxyEnumerate}\hypertarget{md__encapsulations_autotoc_md16}{}\doxysubsubsection{State machine}\label{md__encapsulations_autotoc_md16}
This is the main state machine that takes the dsp through its startup and controls the amp power.
\begin{DoxyItemize}
\item OFF
\begin{DoxyItemize}
\item if Power\+State != OFF -\/-\/\texorpdfstring{$>$}{>} DSP\+\_\+\+START
\end{DoxyItemize}
\item DSP\+\_\+\+START
\begin{DoxyItemize}
\item DSP relay on
\item -\/-\/\texorpdfstring{$>$}{>} DSP\+\_\+\+WAIT
\end{DoxyItemize}
\item DSP\+\_\+\+WAIT
\begin{DoxyItemize}
\item if DSP connected() -\/-\/\texorpdfstring{$>$}{>} DSP\+\_\+\+INITIAL\+\_\+\+STATE
\end{DoxyItemize}
\item DSP\+\_\+\+INITIAL\+\_\+\+STATE
\begin{DoxyItemize}
\item be sure we have input and volume
\item -\/-\/\texorpdfstring{$>$}{>} DSP\+\_\+\+INIT\+\_\+\+INPUT
\end{DoxyItemize}
\item DSP\+\_\+\+INIT\+\_\+\+INPUT
\begin{DoxyItemize}
\item if Chosen\+Input != NA, Set input to Chosen\+Input
\item -\/-\/\texorpdfstring{$>$}{>} DSP\+\_\+\+INIT\+\_\+\+VOLUME
\end{DoxyItemize}
\item DSP\+\_\+\+INIT\+\_\+\+VOLUME
\begin{DoxyItemize}
\item if Current\+Volume \texorpdfstring{$>$}{>} Max\+Initial\+Volume, set volume
\item -\/-\/\texorpdfstring{$>$}{>} AMP\+\_\+\+ON
\end{DoxyItemize}
\item AMP\+\_\+\+ON
\begin{DoxyItemize}
\item Amp power on
\item -\/-\/\texorpdfstring{$>$}{>} ON
\end{DoxyItemize}
\item ON
\begin{DoxyItemize}
\item if Power\+State == OFF -\/-\/\texorpdfstring{$>$}{>} TURN\+\_\+\+OFF
\item if Chosen\+Input != NA \&\& Chosen\+Input != Current\+Input set input
\end{DoxyItemize}
\item TURN\+\_\+\+OFF
\begin{DoxyItemize}
\item Amp power off
\item DSP relay off
\item -\/-\/\texorpdfstring{$>$}{>} OFF
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md__encapsulations_autotoc_md17}{}\doxysubsection{Summary -\/ Power\+Input\+Control Task()}\label{md__encapsulations_autotoc_md17}

\begin{DoxyEnumerate}
\item Direct read inputs
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Input sense state machine
\begin{DoxyItemize}
\item Determines the input state, including persistence in case of silence on the selected input as indicated by the DSP
\end{DoxyItemize}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Power/input select state machine
\begin{DoxyItemize}
\item Based on the input states, determines whether power should be on/off and whether the dsp should be told to use a particular input
\item Provides a period during which the unit will stay on even with inputs inactive. Useful, e.\+g., when turning off the TV with intent to turn on the turntable.
\end{DoxyItemize}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Power/input control state machine
\begin{DoxyItemize}
\item Based on the Power/input select, provides
\begin{DoxyItemize}
\item A proper startup sequence for the dsp and amps
\item Input selection
\end{DoxyItemize}
\end{DoxyItemize}
\end{DoxyEnumerate}

NOTE\+: The output meter shouldn\textquotesingle{}t operate until the amps are on, so wherever the meter update is called should check the power state.\hypertarget{md__encapsulations_autotoc_md18}{}\doxysubsection{Off state (setup) menu}\label{md__encapsulations_autotoc_md18}
Navigation
\begin{DoxyItemize}
\item Rotate (up/down) to choose (discrete options) or set (numeric)
\begin{DoxyItemize}
\item Choice n is BACK
\end{DoxyItemize}
\item Push to select
\item Timeout is back to ground state
\end{DoxyItemize}

Menu heirarchy
\begin{DoxyItemize}
\item Signal timeout
\begin{DoxyItemize}
\item Never
\item 1 min
\item 5 min
\end{DoxyItemize}
\item Max volume
\begin{DoxyItemize}
\item Numeric -\/30..0
\end{DoxyItemize}
\item Max startup volume
\begin{DoxyItemize}
\item Numeric -\/30..0 (not above Max volume)
\end{DoxyItemize}
\item Volume comp (digital-\/analog diff)
\begin{DoxyItemize}
\item Numeric -\/20..0
\end{DoxyItemize}
\item IR Learn (for each, grab code or timeout)
\begin{DoxyItemize}
\item Vol+
\item Vol-\/
\item Mute
\item Source
\item Power
\end{DoxyItemize}
\item Save settings {\itshape -\/ is this needed?}
\begin{DoxyItemize}
\item SAVE
\end{DoxyItemize}
\end{DoxyItemize}

Discrete option menu behavior
\begin{DoxyItemize}
\item Menu function gets array of item names
\item Rotate\+: present next name
\item Select\+: return item number 0..(n-\/1)
\item Back\+: return n
\item Timeout\+: needs to reset to ground state
\end{DoxyItemize}

Numeric option menu behavior
\begin{DoxyItemize}
\item Menu function gets min, max, increment
\item Rotate\+: present number
\item Select\+: return number
\item Timeout\+: needs to reset to ground state
\end{DoxyItemize}

{\bfseries{Discrete and numeric are very similar}}

IRLearn menu behavior
\begin{DoxyItemize}
\item Rotate\+: present command
\item Select\+: prompt to press
\begin{DoxyItemize}
\item Code\+: confirm
\item Timeout\+: say so 
\end{DoxyItemize}
\end{DoxyItemize}